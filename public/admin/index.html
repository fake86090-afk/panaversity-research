<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
  <script>
    // Only load Netlify Identity in non-local environments
    (function(){
      var isLocal = ['localhost','127.0.0.1'].includes(location.hostname);
      if (!isLocal) {
        var s = document.createElement('script');
        s.src = 'https://identity.netlify.com/v1/netlify-identity-widget.js';
        document.head.appendChild(s);
      }
    })();
  </script>
  <script>
    // Prevent auto-fetch of config.yml; we'll inline the config instead
    window.CMS_MANUAL_INIT = true;
  </script>
</head>
<body>
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  <script>
    // Inline Decap CMS config to avoid network fetch of config.yml
    (function(){
      var isLocal = ['localhost','127.0.0.1'].includes(location.hostname);
      var config = {
        backend: { 
          name: 'github', 
          repo: 'fake86090-afk/panaversity-research', 
          branch: 'master',
          use_graphql: true
        },
        media_folder: 'public/img',
        public_folder: '/img',
        publish_mode: 'editorial_workflow',
        collections: [
          {
            name: 'posts',
            label: 'Research Posts',
            folder: 'content/posts',
            create: true,
            slug: '{{slug}}',
            fields: [
              { label: 'Title', name: 'title', widget: 'string' },
              { label: 'Date', name: 'date', widget: 'datetime' },
              { label: 'Author', name: 'author', widget: 'string' },
              { label: 'Summary', name: 'summary', widget: 'string' },
              { label: 'Body', name: 'body', widget: 'markdown' },
              { label: 'Tags', name: 'tags', widget: 'list', field: { label: 'Tag', name: 'tag', widget: 'string' } },
              { label: 'Category', name: 'category', widget: 'select', options: ['AI Research', 'Agentic AI', 'Machine Learning', 'Robotics', 'General Research'] },
              { label: 'Research Status', name: 'status', widget: 'select', options: ['Draft', 'In Progress', 'Peer Review', 'Published', 'Archived'] },
              { label: 'SEO Description', name: 'seo_description', widget: 'text' },
              { label: 'Keywords', name: 'keywords', widget: 'list', field: { label: 'Keyword', name: 'keyword', widget: 'string' } },
              { label: 'Featured Image', name: 'featured_image', widget: 'image', required: false },
              { label: 'Research Team', name: 'research_team', widget: 'list', field: { label: 'Member', name: 'member', widget: 'string' } },
              { label: 'Citations', name: 'citations', widget: 'list', field: { label: 'Citation', name: 'citation', widget: 'text' } },
              { label: 'GitHub Repository', name: 'github_repo', widget: 'string', required: false },
              { label: 'DOI', name: 'doi', widget: 'string', required: false },
            ],
          },
          {
            name: 'research_projects',
            label: 'Research Projects',
            folder: 'content/research_projects',
            create: true,
            slug: '{{slug}}',
            fields: [
              { label: 'Project Title', name: 'title', widget: 'string' },
              { label: 'Description', name: 'description', widget: 'text' },
              { label: 'Start Date', name: 'start_date', widget: 'datetime' },
              { label: 'End Date', name: 'end_date', widget: 'datetime', required: false },
              { label: 'Status', name: 'status', widget: 'select', options: ['Planning', 'Active', 'On Hold', 'Completed', 'Archived'] },
              { label: 'Team Members', name: 'team', widget: 'list', field: { label: 'Member', name: 'member', widget: 'string' } },
              { label: 'GitHub Repositories', name: 'github_repos', widget: 'list', field: { label: 'Repository', name: 'repo', widget: 'string' } },
              { label: 'Research Papers', name: 'papers', widget: 'list', field: { label: 'Paper', name: 'paper', widget: 'string' } },
              { label: 'Funding', name: 'funding', widget: 'text', required: false },
            ],
          },
          {
            name: 'ai_agents',
            label: 'AI Agents',
            folder: 'content/ai_agents',
            create: true,
            slug: '{{slug}}',
            fields: [
              { label: 'Agent Name', name: 'name', widget: 'string' },
              { label: 'Description', name: 'description', widget: 'text' },
              { label: 'Capabilities', name: 'capabilities', widget: 'list', field: { label: 'Capability', name: 'capability', widget: 'string' } },
              { label: 'Use Cases', name: 'use_cases', widget: 'list', field: { label: 'Use Case', name: 'use_case', widget: 'string' } },
              { label: 'GitHub Repository', name: 'github_repo', widget: 'string' },
              { label: 'Documentation', name: 'documentation', widget: 'string', required: false },
              { label: 'Status', name: 'status', widget: 'select', options: ['Development', 'Testing', 'Production', 'Deprecated'] },
            ],
          },
        ],
      };

      // When running locally, use GitHub backend for OAuth testing
      if (isLocal) {
        // Use GitHub backend for local OAuth testing
        config.backend = { 
          name: 'github', 
          repo: 'fake86090-afk/panaversity-research', // Your actual repository
          branch: 'master',
          use_graphql: true
        };
        // Remove local_backend for GitHub testing
        // config.local_backend = true; // uncomment this line if you want to use local proxy instead
      }

      CMS.init({ config: config });
    })();
  </script>
  
  <!-- Minimal uploader to import a local Markdown file into GitHub posts -->
  <script>
    (function(){
      const bar = document.createElement('div');
      bar.style.position = 'fixed';
      bar.style.bottom = '14px';
      bar.style.right = '14px';
      bar.style.zIndex = '9999';
      bar.style.display = 'flex';
      bar.style.gap = '8px';

      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.md,.mdx,text/markdown';
      input.style.padding = '6px 8px';
      input.style.background = '#fff';
      input.style.border = '1px solid #e5e7eb';
      input.style.borderRadius = '6px';

      const btn = document.createElement('button');
      btn.textContent = 'Import Markdown → GitHub';
      btn.style.padding = '6px 10px';
      btn.style.background = '#111827';
      btn.style.color = '#fff';
      btn.style.border = 'none';
      btn.style.borderRadius = '6px';
      btn.style.cursor = 'pointer';

      async function upload() {
        const file = input.files && input.files[0];
        if (!file) { alert('Choose a Markdown file first.'); return; }
        try {
          const fd = new FormData();
          fd.append('file', file);
          const res = await fetch('/api/import-md', { method: 'POST', body: fd });
          const json = await res.json();
          if (!res.ok) throw new Error(json.error || 'Upload failed');
          alert('Imported as ' + json.path);
          location.reload();
        } catch (e) {
          alert('Import failed: ' + (e?.message || e));
        }
      }

      btn.addEventListener('click', upload);
      bar.appendChild(input);
      bar.appendChild(btn);
      document.body.appendChild(bar);
    })();
  </script>

  <!-- Markdown → Decap Post converter (client-side only) -->
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
  <script>
    (function(){
      function toSlug(input){
        return String(input || "")
          .toLowerCase()
          .replace(/[^a-z0-9\s-]/g, "")
          .trim()
          .replace(/\s+/g, "-");
      }

      function parseFrontmatter(md){
        const fmMatch = md.match(/^---\n([\s\S]*?)\n---\n?/);
        if (!fmMatch) return { data: {}, content: md };
        const yaml = fmMatch[1];
        const rest = md.slice(fmMatch[0].length);
        let data = {};
        try { data = window.jsyaml.load(yaml) || {}; } catch(e){ data = {}; }
        return { data, content: rest };
      }

      const wrap = document.createElement('div');
      wrap.style.position = 'fixed';
      wrap.style.bottom = '14px';
      wrap.style.left = '14px';
      wrap.style.zIndex = '9999';
      wrap.style.background = '#ffffff';
      wrap.style.border = '1px solid #e5e7eb';
      wrap.style.borderRadius = '8px';
      wrap.style.padding = '10px';
      wrap.style.maxWidth = '380px';
      wrap.style.boxShadow = '0 4px 14px rgba(0,0,0,0.08)';

      const title = document.createElement('div');
      title.textContent = 'Markdown → Post (convert only)';
      title.style.fontWeight = '600';
      title.style.marginBottom = '8px';

      const file = document.createElement('input');
      file.type = 'file';
      file.accept = '.md,.mdx,text/markdown';
      file.style.marginBottom = '8px';

      const convertBtn = document.createElement('button');
      convertBtn.textContent = 'Convert';
      convertBtn.style.marginLeft = '8px';
      convertBtn.style.padding = '6px 10px';
      convertBtn.style.background = '#111827';
      convertBtn.style.color = '#fff';
      convertBtn.style.border = 'none';
      convertBtn.style.borderRadius = '6px';
      convertBtn.style.cursor = 'pointer';

      const out = document.createElement('div');
      out.style.marginTop = '10px';
      out.style.fontSize = '12px';
      out.style.color = '#111827';

      async function convert(){
        const f = file.files && file.files[0];
        if (!f) { alert('Choose a Markdown file first.'); return; }
        const text = await f.text();
        const { data, content } = parseFrontmatter(text);
        const base = (f.name || '').replace(/\.(md|mdx)$/i, '');
        const title = data.title || base;
        const slug = toSlug(base || title);
        const date = data.date || new Date().toISOString();
        const author = data.author || '';
        const summary = data.summary || '';
        const body = content.trim();

        out.innerHTML = '';
        const makeRow = (label, value) => {
          const row = document.createElement('div');
          row.style.marginBottom = '6px';
          const lab = document.createElement('div');
          lab.textContent = label;
          lab.style.fontWeight = '600';
          lab.style.marginBottom = '2px';
          const ta = document.createElement('textarea');
          ta.value = value || '';
          ta.rows = 2;
          ta.style.width = '100%';
          ta.style.fontFamily = 'ui-monospace, SFMono-Regular, Menlo, Consolas, monospace';
          ta.style.fontSize = '12px';
          ta.addEventListener('focus', () => ta.select());
          const copy = document.createElement('button');
          copy.textContent = 'Copy';
          copy.style.marginTop = '4px';
          copy.style.padding = '4px 8px';
          copy.style.border = '1px solid #e5e7eb';
          copy.style.borderRadius = '6px';
          copy.addEventListener('click', () => { ta.select(); document.execCommand('copy'); });
          row.appendChild(lab);
          row.appendChild(ta);
          row.appendChild(copy);
          return { row, ta };
        };

        const rows = [
          makeRow('Title', title),
          makeRow('Date (ISO)', date),
          makeRow('Author', author),
          makeRow('Summary', summary),
        ];
        const bodyRow = makeRow('Body (Markdown)', body);
        bodyRow.ta.rows = 6;
        rows.push(bodyRow);

        rows.forEach(r => out.appendChild(r.row));

        const openBtn = document.createElement('button');
        openBtn.textContent = 'Open “New Post” and try auto-fill';
        openBtn.style.marginTop = '6px';
        openBtn.style.padding = '6px 10px';
        openBtn.style.background = '#2563eb';
        openBtn.style.color = '#fff';
        openBtn.style.border = 'none';
        openBtn.style.borderRadius = '6px';
        openBtn.style.cursor = 'pointer';
        openBtn.addEventListener('click', () => {
          location.hash = '#/collections/posts/new';
          // best-effort auto-fill after the editor mounts
          setTimeout(() => {
            try {
              const inputs = document.querySelectorAll('input, textarea');
              const setFirst = (needle, value) => {
                for (const el of inputs){
                  const id = el.getAttribute('id') || '';
                  const name = el.getAttribute('name') || '';
                  const aria = el.getAttribute('aria-label') || '';
                  const text = (id + ' ' + name + ' ' + aria).toLowerCase();
                  if (text.includes(needle)) { (el as HTMLInputElement).value = value; (el as HTMLInputElement).dispatchEvent(new Event('input', { bubbles: true })); break; }
                }
              };
              setFirst('title', title);
              setFirst('date', date);
              setFirst('author', author);
              setFirst('summary', summary);
              // body is a markdown editor; paste into first textarea as fallback
              const firstTa = document.querySelector('textarea');
              if (firstTa){ (firstTa as HTMLTextAreaElement).value = body; firstTa.dispatchEvent(new Event('input', { bubbles: true })); }
            } catch {}
          }, 1200);
        });
        out.appendChild(openBtn);
      }

      convertBtn.addEventListener('click', convert);
      wrap.appendChild(title);
      wrap.appendChild(file);
      wrap.appendChild(convertBtn);
      wrap.appendChild(out);
      document.body.appendChild(wrap);
    })();
  </script>
</body>
</html>
